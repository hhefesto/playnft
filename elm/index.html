
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <script type="text/javascript" src="Main.min.js"></script>
    <script src="https://unpkg.com/@metamask/detect-provider/dist/detect-provider.min.js"></script>
    <script src="web3.min.js"></script>
    <script src="constants.js"></script>
    <script src="abi.js"></script>
    <script src="ethereum.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>



    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <!-- <link rel="stylesheet" href="datepicker.css"> -->
    <!-- <link rel="stylesheet" href="custom.css"> -->
    <style>

    </style>
  </head>
  <body onload="myFunction()">
    <div id="playNFT"></div>
    <div id="testText"></div>
  </body>
  <script type="text/javascript">
    const myFunction = _ => {
      console.log("BLAAAAAAAAAAAAAAAAAAA!@!!!!");
    };
    var app = Elm.Main.init({
      node: document.getElementById('playNFT')
    });
    
    
    // const web3 = new Web3(constants.providerHost);
    // console.log("web3");
    // console.log(web3);
    // const contract = new web3.eth.Contract(site, constants.contractAddress);
    // console.log("contract");
    // console.log(contract);
    
    // socket.addEventListener("message", function(event) {
    //   app.ports.messageReceiver.send(event.data);
    // });

      app.ports.sendMessage.subscribe(function(message) {
          console.log("1111111111111");
        console.log(message);
          siteContract.then(sc => {
              console.log("2222222222222");
            sc.methods.getTestMessage().call().then((tm) => {
                console.log("3333333333333333");
            console.log(tm);
            app.ports.messageReceiver.send(tm);
            // app.ports.
            // document.getElementById("testText").innerHTML = tm;
            }).catch(err => {
                console.log("44444444444444444444");
                console.log(err);
            });
        })
    });
    // // returns {artistName, imgUrl, timeText, bidAmount, featureRequest, artId, featureId}
    // const getArtDisplay = function (i) { // i is the artId

    app.ports.getArtDisplaySend.subscribe(function(artId) {
        getArtDisplay(artId).then(x => {
            app.ports.getArtDisplayReceiver.send(x);
        });
    });
    app.ports.controlStartArtWithFeatureSend.subscribe(function(featureEndTime, imageData) {
        controlStartArtWithFeature(featureEndTime, imageData).then(_ => {
            app.ports.controlStartArtWithFeatureReceiver.send(true);
        }).catch(_ => {
            app.ports.controlStartArtWithFeatureReceiver.send(false);
        });
    });
    app.ports.addArtistSend.subscribe(function(addr) {
        addArtist(addr).then(x => {
            app.ports.addArtistReceiver.send(true);
        }).catch(_ => {
            app.ports.addArtistReceiver.send(false);
        });
    });
    app.ports.getArtistSend.subscribe(function(addr) {
        console.log("HERE!!!!!!!!") // this does trigger
        try
        {getArtist(addr).then(x => {
            console.log("THEN HERE!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!");
            app.ports.getArtistReceiver.send(x);
        }).catch(y => { // CATCH doesn't fire when provided a wrong addr and THEN also wasn't triggered. Throws "Uncaught (in promise) Error: bad address checksum". TODO: FIX
            console.log("CATCH HERE!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!");
            app.ports.getArtistErrorReceiver.send(y);
        }).finally(x => { console.log("FINALLY HERE!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!");});
        }catch (y){console.log("TRY HERE!!!!!!!!!!!!!!!!!!!!!")} // Also doesn't trigger. TODO Fix
        });
      
    // function getNumArt () public view returns (uint) {
    app.ports.getNumArtSend.subscribe(function() {
        getNumArt().then(x => {
            aux = parseInt(x)
            if(isNaN(aux)){
                app.ports.getNumArtReceiver.send(-1);
            }else {
                app.ports.getNumArtReceiver.send(aux);
            }
        }).catch(y => {
            console.log(y);
            app.ports.getNumArtReceiver.send(-1);
        });
    });

    // function getNumArtist () public view returns (uint) {
    app.ports.getNumArtistSend.subscribe(function() {
        getNumArtists().then(x => {
            aux = parseInt(x)
            if(isNaN(aux)){
                app.ports.getNumArtistReceiver.send(-1);
            }else {
                app.ports.getNumArtistReceiver.send(aux);
            }
        }).catch(y => {
            console.log(y);
            app.ports.getNumArtistReceiver.send(-1);
        });
    });

    // function getArt (uint i) public view returns (address, bool, int64) {
    app.ports.getArtSend.subscribe(function(artId) {
        
        getArt(artId).then(x => {
            app.ports.getArtReceiver.send(x);
        }).catch(x =>{
            console.log("¡¡¡¡¡¡¡¡¡¡¡This will wrongfully never be triggered!!!!!!!!!!!!!!!"); // Also unable to catch. See getArtistSend. TODO Fix
        });
    });

    // function getFeature (uint64 featureId) public view returns (uint, uint, int64, int64, bool) {
    app.ports.getFeatureSend.subscribe(function(artId) {
        
        getFeature(artId).then(x => {
            
            app.ports.getFeatureReceiver.send(x);
        }).catch(x =>{
            console.log("¡¡¡¡¡¡¡¡¡¡¡This will wrongfully never be triggered!!!!!!!!!!!!!!!"); // Also unable to catch. See getArtistSend. TODO Fix
        });
    });
      
    // function getDisplayFeature (uint16 artId) public view returns (int64) {
    app.ports.getDisplayFeatureSend.subscribe(function(artId) {
        
        getDisplayFeature(artId).then(x => {
            aux = parseInt(x)
            if(isNaN(aux)){
                app.ports.getDisplayFeatureReceiver.send(-1);
            }else {
                app.ports.getDisplayFeatureReceiver.send(aux);
            }
            
        }).catch(x =>{
            console.log("¡¡¡¡¡¡¡¡¡¡¡This will wrongfully never be triggered!!!!!!!!!!!!!!!"); // Also unable to catch. See getArtistSend. TODO Fix
        });
    });
    
    // function getBid (uint64 bidId) public view returns (int64, address payable, uint, string memory) {
    app.ports.getBidSend.subscribe(function(bidId) {
        
        getBid(bidId).then(x => {
            
            app.ports.getBidReceiver.send(x);
        }).catch(x =>{
            console.log("¡¡¡¡¡¡¡¡¡¡¡This will wrongfully never be triggered!!!!!!!!!!!!!!!"); // Also unable to catch. See getArtistSend. TODO Fix
        });
    });

    // function modifyArtistProfile (string memory _name, string memory _description) public {
    app.ports.modifyArtistProfileSend.subscribe(function(args) {
        var [name, description] = args;
        modifyArtistProfile(name, description).then(_ => {
            app.ports.modifyArtistProfileReceiver.send(true);
        }).catch(_ => {
            app.ports.modifyArtistProfileReceiver.send(false);
        });
    });
    // function startArtWithFeature () public {
    app.ports.startArtWithFeatureSend.subscribe(_ => {
        startArtWithFeature().then(_ => {
            app.ports.startArtWithFeatureReceiver.send(true);
        }).catch(_ => {
            app.ports.startArtWithFeatureReceiver.send(false);
        });
    });
    // function startFeature (uint64 artId, uint _endTime) public {
    app.ports.startFeatureSend.subscribe(args => {
        var [artId, endTimeInt] = args;
        startFeature(artId, endTimeInt).then(_ => {
            app.ports.startFeatureReceiver.send(true);
        }).catch(_ => {
            app.ports.startFeatureReceiver.send(false);
        });
    });
    // function makeBid (uint64 artId, string memory _request) public payable returns (bool, string memory) {
    app.ports.makeBidSend.subscribe(args => {
        var [artId, request] = args;
        makeBid(artId, request).then(x => {
            app.ports.makeBidReceiver.send(x);
        });
    });
    // function nextFeature (uint64 artId, uint endTime) public {
    app.ports.nextFeatureSend.subscribe(args => {
        var [artId, endTimeInt] = args;
        nextFeature(artId, endTimeInt).then(_ => {
            app.ports.nextFeatureReceiver.send(true);
        }).catch(_ => {
            app.ports.nextFeatureReceiver.send(false);
        });
    });
    // function finishArt (uint64 artId) public {
    app.ports.finishArtSend.subscribe(artId => {
        finishArt(artId).then(_ => {
            app.ports.finishArtReceiver.send(true);
        }).catch(_ => {
            app.ports.finishArtReceiver.send(false);
        });
    });

  </script>

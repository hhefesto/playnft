
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <script type="text/javascript" src="Main.min.js"></script>
    <script src="https://unpkg.com/@metamask/detect-provider/dist/detect-provider.min.js"></script>
    <script src="web3.min.js"></script>
    <script src="constants.js"></script>
    <script src="abi.js"></script>
    <script src="ethereum.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>



    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <!-- <link rel="stylesheet" href="datepicker.css"> -->
    <!-- <link rel="stylesheet" href="custom.css"> -->
    <style>

    </style>
  </head>
  <body>
  <!-- <body onload="myFunction()"> -->
    <div id="playNFT"></div>
    <div id="testText"></div>
  </body>
  <script type="text/javascript">
    
    var app = Elm.Main.init({
      node: document.getElementById('playNFT')
    });
    
    
    app.ports.sendMessage.subscribe(function(message) {
        console.log("1111111111111");
        console.log(message);
          siteContract.then(sc => {
              console.log("2222222222222");
            sc.methods.getTestMessage().call().then((tm) => {
                console.log("3333333333333333");
            console.log(tm);
            app.ports.messageReceiver.send(tm);
            // app.ports.
            // document.getElementById("testText").innerHTML = tm;
            }).catch(err => {
                console.log("44444444444444444444");
                console.log(err);
            });
        })
    });
    app.ports.getArtDisplaySend.subscribe(function(artId) {
        getArtDisplay(artId).then(x => {
            app.ports.getArtDisplayReceiver.send(x);
        });
    });
    app.ports.controlStartArtWithFeatureSend.subscribe(function(featureEndTime, imageData) {
        controlStartArtWithFeature(featureEndTime, imageData).then(receipt => {
            alert("new art created");
            app.ports.controlStartArtWithFeatureReceiver.send(true);
        }, err => {
                    alert(err.error);
                    console.log(err);
                }).catch(_ => {
            app.ports.controlStartArtWithFeatureReceiver.send(false);
        });
    });
    app.ports.addArtistSend.subscribe(function(addr) {
        addArtist(addr).then(x => {
            app.ports.addArtistReceiver.send(true);
        }).catch(_ => {
            app.ports.addArtistReceiver.send(false);
        });
    });
    app.ports.getArtistSend.subscribe(function(addr) {
        // try{
        getArtist(addr).then(x => {
            app.ports.getArtistReceiver.send(x);
        }).catch(y => { // CATCH doesn't fire when provided a wrong addr and THEN also wasn't triggered. Throws "Uncaught (in promise) Error: bad address checksum". TODO: FIX
            app.ports.getArtistErrorReceiver.send(y);
        }).finally(x => { console.log("FINALLY HERE!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!");});
        // }catch (y){console.log("TRY HERE!!!!!!!!!!!!!!!!!!!!!")} // Also doesn't trigger. TODO Fix
    });
    app.ports.getNumArtSend.subscribe(function() {
        getNumArt().then(x => {
            aux = parseInt(x)
            if(isNaN(aux)){
                app.ports.getNumArtReceiver.send(-1);
            }else {
                app.ports.getNumArtReceiver.send(aux);
            }
        }).catch(y => {
            console.log(y);
            app.ports.getNumArtReceiver.send(-1);
        });
    });
    app.ports.getNumArtistSend.subscribe(function() {
        getNumArtists().then(x => {
            aux = parseInt(x)
            if(isNaN(aux)){
                app.ports.getNumArtistReceiver.send(-1);
            }else {
                app.ports.getNumArtistReceiver.send(aux);
            }
        }).catch(y => {
            console.log(y);
            app.ports.getNumArtistReceiver.send(-1);
        });
    });
    app.ports.getArtSend.subscribe(function(artId) {
        
        getArt(artId).then(x => {
            app.ports.getArtReceiver.send(x);
        }).catch(x =>{
            console.log("¡¡¡¡¡¡¡¡¡¡¡This will wrongfully never be triggered!!!!!!!!!!!!!!!"); // Also unable to catch. See getArtistSend. TODO Fix
        });
    });
    app.ports.getFeatureSend.subscribe(function(artId) {
        
        getFeature(artId).then(x => {
            
            app.ports.getFeatureReceiver.send(x);
        }).catch(x =>{
            console.log("¡¡¡¡¡¡¡¡¡¡¡This will wrongfully never be triggered!!!!!!!!!!!!!!!"); // Also unable to catch. See getArtistSend. TODO Fix
        });
    });
    app.ports.getDisplayFeatureSend.subscribe(function(artId) {
        
        getDisplayFeature(artId).then(x => {
            aux = parseInt(x)
            if(isNaN(aux)){
                app.ports.getDisplayFeatureReceiver.send(-1);
            }else {
                app.ports.getDisplayFeatureReceiver.send(aux);
            }
            
        }).catch(x =>{
            console.log("¡¡¡¡¡¡¡¡¡¡¡This will wrongfully never be triggered!!!!!!!!!!!!!!!"); // Also unable to catch. See getArtistSend. TODO Fix
        });
    });
    app.ports.getBidSend.subscribe(function(bidId) {
        getBid(bidId).then(x => {
            app.ports.getBidReceiver.send(x);
        }).catch(x =>{
            console.log("¡¡¡¡¡¡¡¡¡¡¡This will wrongfully never be triggered!!!!!!!!!!!!!!!"); // Also unable to catch. See getArtistSend. TODO Fix
        });
    });
    app.ports.modifyArtistProfileSend.subscribe(function(args) {
        var [name, description] = args;
        modifyArtistProfile(name, description).then(_ => {
            app.ports.modifyArtistProfileReceiver.send(true);
        }).catch(_ => {
            app.ports.modifyArtistProfileReceiver.send(false);
        });
    });
    app.ports.startArtWithFeatureSend.subscribe(_ => {
        startArtWithFeature().then(_ => {
            app.ports.startArtWithFeatureReceiver.send(true);
        }).catch(_ => {
            app.ports.startArtWithFeatureReceiver.send(false);
        });
    });
    app.ports.startFeatureSend.subscribe(args => {
        var [artId, endTimeInt] = args;
        startFeature(artId, endTimeInt).then(_ => {
            app.ports.startFeatureReceiver.send(true);
        }).catch(_ => {
            app.ports.startFeatureReceiver.send(false);
        });
    });
    app.ports.makeBidSend.subscribe(args => {
        var [artId, request] = args;
        makeBid(artId, request).then(x => {
            app.ports.makeBidReceiver.send(x);
        });
    });
    app.ports.nextFeatureSend.subscribe(args => {
        var [artId, endTimeInt] = args;
        nextFeature(artId, endTimeInt).then(_ => {
            app.ports.nextFeatureReceiver.send(true);
        }).catch(_ => {
            app.ports.nextFeatureReceiver.send(false);
        });
    });
    app.ports.finishArtSend.subscribe(artId => {
        finishArt(artId).then(_ => {
            app.ports.finishArtReceiver.send(true);
        }).catch(_ => {
            app.ports.finishArtReceiver.send(false);
        });
    });
    app.ports.getArtListSend.subscribe(_ => {
        console.log("Here!!!!!!!!!!!!!!!!!!!!!");
        getArtList().then(al => {
            console.log("Here!!!!!!!!!!!!!!!!!!!!!0");
            app.ports.getArtListReceiver.send(al);
        }).catch(_ => {
            console.log("Here!!!!!!!!!!!!!!!!!!!!!1");
            app.ports.getArtListReceiver.send([]);
        });
    });

  </script>
